# Datadog Synthetic Events

A tool for simulating and sending synthetic events to Datadog via both API and email for testing and demonstration purposes.

## Overview

This project allows you to:
1. Generate synthetic monitoring events from predefined scenarios
2. Send events to Datadog via direct API calls
3. Send events via email to be parsed by Datadog's email integration
4. Simulate different alert patterns and test Datadog's processing capabilities

## Prerequisites

- Python 3.8+
- Datadog API and APP keys
- SendGrid API key (for email functionality)
- Docker (optional, for containerized execution)

## Installation

### Local Setup

1. Clone the repository:
   ```
   git clone https://github.com/yourusername/datadog-synthetic-events.git
   cd datadog-synthetic-events
   ```

2. Create a virtual environment and install dependencies:
   ```
   python -m venv venv
   source venv/bin/activate  # On Windows: venv\Scripts\activate
   pip install -r requirements.txt
   ```

3. Set up environment variables:
   ```
   export DD_API_KEY="your_datadog_api_key"
   export DD_APP_KEY="your_datadog_app_key"
   export SENDGRID_API_KEY="your_sendgrid_api_key"
   export EMAIL_TO="destination_email@example.com"
   export EMAIL_FROM="source_email@example.com"
   ```

   Alternatively, copy the `set_datadog_env.sh` template and fill in your keys:
   ```
   cp set_datadog_env.sh.template set_datadog_env.sh
   # Edit set_datadog_env.sh with your keys
   source set_datadog_env.sh
   ```

### Docker Setup

1. Build the Docker image:
   ```
   docker build -t datadog-synthetic-events .
   ```

2. Run the container with environment variables:
   ```
   docker run -e DD_API_KEY="your_datadog_api_key" \
              -e DD_APP_KEY="your_datadog_app_key" \
              -e SENDGRID_API_KEY="your_sendgrid_api_key" \
              -e EMAIL_TO="destination_email@example.com" \
              -e EMAIL_FROM="source_email@example.com" \
              datadog-synthetic-events
   ```

## Usage

### Running the Simulator

Use the `run.sh` script to execute the simulator:

```
./run.sh [scenario_name] [--api-only] [--email-only]
```

- `scenario_name`: Name of the scenario folder in `examples/scenarios/` (defaults to "scenario1" if not specified)
- `--api-only`: Only send events via the Datadog API
- `--email-only`: Only send events via email

Example:
```
./run.sh scenario2 --email-only
```

### Creating Custom Scenarios

Scenarios are defined in the `examples/scenarios/` directory. Each scenario should contain:

1. `api_events.json` - Events to be sent directly via Datadog API
2. `email_events.json` - Event templates for email sending
3. `email_logs.json` - Simulated log events to be sent via email

Example scenario file structure:
```
examples/scenarios/my_scenario/
  ├── api_events.json
  ├── email_events.json
  └── email_logs.json
```

#### API Events Format

```json
{
  "events": [
    {
      "title": "Event title",
      "text": "Event description and details",
      "alert_type": "error|warning|info|success",
      "source_type_name": "my_apps",
      "tags": ["key1:value1", "key2:value2"]
    }
  ]
}
```

#### Email Events Format

```json
{
  "events": [
    {
      "subject": "Email subject line",
      "body": "Email body text with alert details",
      "tags": ["key1:value1", "key2:value2"]
    }
  ]
}
```

#### Email Logs Format

```json
{
  "events": [
    {
      "source": "source_name",
      "service": "service_name",
      "hostname": "host_name",
      "tags": ["key1:value1", "key2:value2"],
      "content": "Log content with structured alert information"
    }
  ]
}
```

## Datadog Configuration

### Email Integration Setup

1. In Datadog, navigate to **Integrations** > **Integrations**
2. Find and install the **Email** integration
3. Configure a unique email address for receiving logs
4. Set this email as the destination in your environment variables (`EMAIL_TO`)

### Pipeline Configuration

To properly parse the email alerts generated by this tool, set up the following pipeline in Datadog:

1. Navigate to **Logs** > **Configuration** > **Pipelines**
2. Create a new pipeline for email alerts with a filter like `source:email`
3. Add a Grok Parser processor with the following rule:

```
rule_name .*Alert Title:\s*%{data:alert_title}\s*Alert Description:\s*%{data:alert_description}\s*Alert Type:\s*%{data:alert_type}\s*Severity:\s*%{data:severity}\s*Alert Level:\s*%{data:alert_level}\s*Device:\s*%{data:device}\s*Time Detected:\s*%{data:time_detected}\s*Notification Time:\s*%{data:notification_time}\s*Notification Policy:\s*%{data:notification_policy}\s*Action Name:\s*%{data:action_name}\s*User URL:\s*%{data:user_url}\s*Location:\s*%{data:location}\s*Primary Contact:\s*%{data:primary_contact}\s*Notes:\s*%{data:notes}\s*Alert ID:\s*%{data:alert_id}\s*Version:\s*%{data:version}
```

This parser extracts structured attributes from the alert emails.

### Location Normalization

To enhance correlation capabilities:

1. Set up an IP Lookup processor to set a normalized location
2. Add a Category Processor to match and normalize the Location attribute

### Correlation Configuration

To correlate events across different sources:

1. Go to **Logs** > **Configuration** > **Correlations**
2. Create a new correlation with a relevant name (e.g., "Alert Correlation")
3. Define correlation criteria using attributes extracted by the pipeline:
   - Primary identifier: `alert_id`
   - Supporting attributes: `alert_title`, `severity`, `location`

This will help group related alerts from different sources (API and email) for better incident management.

## Troubleshooting

- **Events not appearing in Datadog**: Verify your API keys and check that your network allows connections to Datadog's endpoints.
- **Email not being processed**: Confirm your SendGrid API key is valid and that the destination email is correctly configured in Datadog's email integration.
- **Pipeline not parsing emails**: Review the Grok rule syntax and test it in Datadog's Pipeline testing tool with a sample of your email content.

## License

[Your License Information]

## Contributing

[Your Contribution Guidelines]